import { useEffect, useState } from 'react';
import WebApp from '@twa-dev/sdk';
import {
  listEventParticipants,
  getMyEventReminders,
  setMyEventReminders,     // –≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ –±—ã–ª–æ —Å chatId
  primeEventReminders,
  createEventInvite,
  updateEvent,
} from '../api';


export default function EventPanel({
  eventId,
  startAt,
  endAt,
  chatId,
  isOrganizer,
}: {
  eventId: string;
  startAt: string;
  endAt?: string | null;
  chatId: string;
  isOrganizer: boolean;
}) {
  const [participants, setParticipants] = useState<{ chatId: string; name?: string | null; role: string }[]>([]);
  const [myOffsets, setMyOffsets] = useState<number[]>([]);
  const presets = [5, 15, 60, 24 * 60]; // –º–∏–Ω








useEffect(() => {
  let ignore = false;
  (async () => {
    try {
      const r = await listEventParticipants(eventId);
      if (!ignore && r?.ok) setParticipants(r.participants || []);
    } catch {}
  })();
  return () => { ignore = true; };
}, [eventId]);




useEffect(() => {
  let ignore = false;
  (async () => {
    try {
      const r = await getMyEventReminders(eventId, chatId);
      if (ignore || !r?.ok) return;
      const offs = Array.isArray(r.offsets) && r.offsets.length
        ? r.offsets
        : (r.reminders || []).map((x: any) => x.offsetMinutes);
      setMyOffsets([...new Set(offs)].sort((a, b) => a - b));
    } catch {}
  })();
  return () => { ignore = true; };
}, [eventId, chatId]);






  const togglePreset = async (m: number) => {
    const next = myOffsets.includes(m)
      ? myOffsets.filter(x => x !== m)
      : [...myOffsets, m].sort((a,b)=>a-b);
    setMyOffsets(next);
    await setMyEventReminders(eventId, chatId, next);
    WebApp?.HapticFeedback?.impactOccurred?.('light');
  };

  const invite = async () => {
    const r = await createEventInvite(eventId, chatId);
    if (!r.ok) return;
    const text = r.shareText || '–ü—Ä–∏–≥–ª–∞—à–∞—é —Ç–µ–±—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ';
    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(r.link)}&text=${encodeURIComponent(text)}`;
    WebApp?.openTelegramLink?.(shareUrl);
  };

  const prime = async () => {
    if (!confirm('–†–∞–∑–æ—Å–ª–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º?')) return;
    const r = await primeEventReminders(eventId, chatId);
    if (r.ok) {
      alert(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${r.primed}. –ü—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ—Ç writeAccess): ${r.skipped.length}`);
    }
  };

  const fmt = (iso?: string | null) =>
    iso ? new Date(iso).toLocaleString() : '‚Äî';

  return (
    <div style={{ marginTop: 12, padding: 12, border: '1px solid #2a3346', borderRadius: 12 }}>
  <div style={{ marginBottom: 8, opacity: .8 }}>
  üóì {fmt(startAt)}{endAt ? ` ‚Äî ${fmt(endAt)}` : ''}{' '}
  {isOrganizer && (
    <button
      onClick={async () => {
        const s0 = startAt ? new Date(startAt) : new Date();
        const e0 = endAt ? new Date(endAt) : s0;
        const s = prompt('–ù–æ–≤–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (ISO)', s0.toISOString());
        if (!s) return;
        const e = prompt('–ù–æ–≤–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞ (ISO)', e0.toISOString());
        if (!e) return;
        const r = await updateEvent(eventId, chatId, { startAt: s, endAt: e });
        if (r.ok) {
          alert('–î–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
          // –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º—Å—è
          location.reload();
        } else {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã');
        }
      }}
      style={{ marginLeft: 8, background: 'transparent', border: '1px solid #2a3346', borderRadius: 8, color: '#8aa0ff', padding: '2px 6px' }}
      title="–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã —Å–æ–±—ã—Ç–∏—è"
    >
      –ò–∑–º–µ–Ω–∏—Ç—å
    </button>
  )}
</div>


      <div style={{ margin: '8px 0' }}>
        <div style={{ fontWeight: 600, marginBottom: 6 }}>–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
          {participants.map(p => (
            <div key={p.chatId} style={{ padding: '6px 10px', border: '1px solid #2a3346', borderRadius: 999 }}>
              {p.name || p.chatId}{p.role === 'ORGANIZER' ? ' ‚Ä¢ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä' : ''}
            </div>
          ))}
        </div>
      </div>

      <div style={{ margin: '8px 0' }}>
        <div style={{ fontWeight: 600, marginBottom: 6 }}>–ú–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
          {presets.map(m => (
            <button key={m}
              onClick={() => togglePreset(m)}
              style={{
                padding: '6px 10px',
                borderRadius: 999,
                border: myOffsets.includes(m) ? '1px solid #8ab4ff' : '1px solid #2a3346',
                background: myOffsets.includes(m) ? '#172036' : 'transparent',
                color: 'inherit',
              }}>
              {m >= 60 ? `${m/60} —á` : `${m} –º–∏–Ω`}
            </button>
          ))}
        </div>
      </div>

      {isOrganizer && (
        <div style={{ display: 'flex', gap: 8, marginTop: 10 }}>
          <button onClick={invite} style={{ padding: '8px 12px', borderRadius: 10, border: '1px solid #2a3346' }}>
            –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
          </button>
          <button onClick={prime} style={{ padding: '8px 12px', borderRadius: 10, border: '1px solid #2a3346' }}>
            –ü—Ä–∞–π–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
          </button>
        </div>
      )}
    </div>
  );
}
